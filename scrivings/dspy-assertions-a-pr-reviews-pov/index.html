<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DSPy Assertions: A PR Review&#39;s POV | Manish Shetty</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://manishs.org/blog/favicon.ico">
<script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";

    const defaults = {
        securityLevel: "loose",
        theme: "default",
        themeVariables: {
            fontFamily: 'BlinkMacSystemFont, -apple-system, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Helvetica, Arial, sans-serif',
        },
    };

    mermaid.initialize({ ...defaults, ...true });
</script>    <link rel="stylesheet" href="https://manishs.org/blog/theme/css/main.css" type="text/css" />
    <link rel="preload" href="https://manishs.org/blog/fonts/et-bembo-roman-line-figures/et-bembo-roman-line-figures.woff" as="font" type="font/woff" crossorigin>
    <link rel="canonical" href="https://manishs.org/blog/scrivings/dspy-assertions-a-pr-reviews-pov/">
    <meta property="og:url" content="https://manishs.org/blog/scrivings/dspy-assertions-a-pr-reviews-pov/">
    <link rel="author" href="https://manishs.org/blog/about/">
    <meta name="author" content="Manish Shetty" />
    <meta name="title" content="DSPy Assertions: A PR Review&#39;s POV" />
    <meta name="description" content="Deep connections between traditional program synthesis and self-refining LM programs with assertions." />
    <meta property="og:description" content="Deep connections between traditional program synthesis and self-refining LM programs with assertions.">
    <meta property="og:site_name" content="manishs.org | Manish">
    <meta property="og:title" content="DSPy Assertions: A PR Review&#39;s POV">
    <meta property="og:image" content="https://manishs.org/blog/images/eric_head.jpg">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:creator" content="@slimshetty_">
    <meta name="twitter:site" content="@slimshetty_">
    <meta name="keywords" content="DSPy,LLM,Assertions,Program Recovery,Program Synthesis,PL" />
    <meta property="article:tag" content="DSPy,LLM,Assertions,Program Recovery,Program Synthesis,PL" />

    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2023-12-15T06:31:00.000000">
    <meta property="article:author" content="Manish Shetty" />
    <meta property="article:section" content="Research" />
</head>
<body>
    <aside id="asidebar">
        <div id="logo">
            <a href="https://manishs.org/blog/"><img src="https://manishs.org/blog/images/logo.png" alt="your-domain.com logo" /></a>
        </div>
        <nav class="main-menu">
<ul>
    <li><a href="https://manishs.org/blog/">Home</a></li>
    <li><a href="https://manishs.org/blog/scrivings/">Vault</a></li>
    <li><a href="https://manishs.org/blog/tags/">Tags</a></li>
</ul>        </nav>

<ul id="social">
    <li><a href="https://twitter.com/slimshetty_" title="Twitter" target=_blank rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wMSEh0cFXthBQAAAQBJREFUOMvN0r0ugwEUxvHf+24Wciw1WBCRGJqYKoziAlyAwWawWlyAWK0uoJsbsDARg8RMImwMzYlIk0oES9u8RDVNDJ7xPPk/5yOHv1BE1Ib4hxHRioiXiGh2a42IqBcR0cAJpjPz5Qf4BOs/5N5iu0QN48iIWPsGTwyAYR7tIiIm0aoYd9jFFTp4HBCwkpkXJUrsV4xZHOP+F1ivaYk57OFjxNs/Q5mZl7hGMWJAfwKZuYTTEeCDzHxT7RoRo6wwlpmd/gRdTaGN9yHwag/+EpCZT91/OPoF3snM82qhiIgNLGATiwPAV9Qz8+a7UXT3n0ETyxXvAw/Yyswz/1afvZNND5Cv/IgAAAAASUVORK5CYII=" alt="Twitter"></a></li>
    <li><a href="https://github.com/manishshettym" title="GitHub" target=_blank rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wMQBSkoPIUbOQAAAWNJREFUOMuVk7FKQzEUhr970UmXDklG26UKFfUFFCm+gopTJx0UHOpWfAAdHBx00CfQDvoAHUR0FRSk6NI6JpkEnapel3NLCLXUA4F7kv//85+TcxMkjNJY7zBKV4A9YBmYkuM34AY4st4951iAJCJfAGsMj0vr3XrOSQLyC1BmtHi13k0bpUmF3BTyE1ADugJ8l4Xs1QRTNko3cwdzwKOAzq13W8OuNkqfAZuSzqdAPTgfG8F+iKknRulu0O1J4DPv8IDbASaAj/x1EqP0j7zGl/VufJQOGqV74iRLgewf9uMyshToBMpVsflnCUbparDVSYFW4OIaKEaEUKMIXAV5KzFKF8XFPlABNoAHYNd6dy9CS8AxsBCZKuWjfAJsA7PyH5SAFeA7qLkXkU+tdzvhKN8CM8Aq4Kx37aj+LEjvrHeL/fLyD6P0gVE6i8B9AVmHISceEozSBaN0Y4BAwyhdiMm/6K92B5mUXmkAAAAASUVORK5CYII=" alt="GitHub"></a></li>
    <li><a href="https://www.linkedin.com/in/manishshettym/" title="LinkedIn" target=_blank rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wMSEiICt6p2WgAAARdJREFUOMudU0GKg0AQrJ7VQ25pCQSEfCDfyKs2ePC0z/EHOUZy8g85iXgwigddxNrTDGui7JqCgammp6Z7ukZU9RPAF97DWVSVlokISK5SMHaTZRnyPEeSJOsFRARhGML3fRyPx1VVGAAgiTRNUZYlLpcLROQlkeSssHsDY4xLIAljjNsDQBzH8DwPURRNhVSV2+2Wj8eD4zjydrtN+P1+5zAMHMfRrd1uR1WlqtLMlfobh8PBVWNxvV5fp7CEqqoQBAGCIEBRFACA/X7vLvpTwB4SEeR5vuyDJdR17abS9/16gX878V14tr+2bQEAXde9cIuu69A0Ddq2dW1NPhPJiQuf+VzsY7PZfAM42UomNp2x9FPs/AN6xJlXb4YRtgAAAABJRU5ErkJggg==" alt="LinkedIn"></a></li>
</ul>    </aside>
    <main>            <article>
                <header>
                    <h1>
                        <a href="https://manishs.org/blog/scrivings/dspy-assertions-a-pr-reviews-pov/" rel="bookmark" class="no-line" title="Permanent link to &quot;DSPy Assertions: A PR Review's POV&quot;">DSPy Assertions: A PR Review's POV</a>                    </h1>

                    <p><span class="newthought">Manish Shetty</span></p>
                    <p><span class="newthought">December 15, 2023</span></p>
                        <p><span class="newthought">Filed under &ldquo;<a href="https://manishs.org/blog/categories/research/" rel="tag">Research</a>&rdquo;</span></p>
                </header>

                <section>
<p>Prompting emerged as a way to &ldquo;interact&rdquo; with LMs due to the naturalness of language.
We soon realized one needs to &ldquo;engineer&rdquo; their prompts to get desired outputs from these stochastic machines. <em>While interactions are natural and imprecise, engineering is anything but.</em></p>
<p>Mixing the medium for interaction and engineering results in hand-crafted <code>prompt templates</code>â€”an error-prone practice, often verbose, and doesnâ€™t always generalize.</p>
<p>That leads us to the question: <strong>How can we program LMs without prompting?</strong></p>
<p>Language model (LM) programs are a programming paradigm that
combines the precision of conventional programming with the flexibility of
LMs. <a href="https://github.com/stanfordnlp/dspy">DSPy</a> is a framework for creating such programs declaratively, with automatic prompt tuning through compilation.
<label for="sn-demo" class="margin-toggle sidenote-number"></label>
<input type="checkbox" id="sn-demo" class="margin-toggle"/>
<span class="sidenote">
  This <a href="https://arnavsinghvi11.github.io/posts/2023/10/6/blog-post/">short blog</a> summarizes how DSPy works in a nutshell. You can try DSPy in this free <a href="https://colab.research.google.com/github/stanfordnlp/dspy/blob/main/intro.ipynb">Colab</a>.
</span>
Let&rsquo;s build a simple ubercool LM program.</p>
<h3>PR Reviewer with DSPy</h3>
<p>This program reviews a GitHub pull request:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Reviewer</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gen_review</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="s2">&quot;pull_request -&gt; review, status&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_review</span><span class="p">(</span><span class="n">pull_request</span><span class="o">=</span><span class="n">pr</span><span class="p">)</span>
</code></pre></div>

<p>You could use this program as follows:</p>
<div class="highlight"><pre><span></span><code><span class="n">reviewer</span> <span class="o">=</span> <span class="n">Reviewer</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">reviewer</span><span class="p">(</span><span class="n">pr</span><span class="o">=</span><span class="s2">&quot;def add(a, b): return a - b&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">review</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

<span class="c1"># review: ... could be improved by renaming </span>
<span class="c1"># the function and adding proper error handling.</span>
<span class="c1"># status: Changes requested</span>
</code></pre></div>

<p>DSPy also automatically compiles quality few-shot prompts for your program, so you don&rsquo;t have to! You can use it to build a more robust reviewer in a few lines and some I/O pairs.
<label for="sn-demo" class="margin-toggle sidenote-number"></label>
<input type="checkbox" id="sn-demo" class="margin-toggle"/>
<span class="sidenote">
    Imagine collecting a few hundred I/O pairs from GitHub PRs and compiling a reviewer that is robust to unseen PRs. ðŸ¤© 
    </br></br>
    In the code, <code>is_valid</code> is the optimizer metric and could be a fuzzy string match or an LLM call that checks the review&rsquo;s validity.
</span></p>
<div class="highlight"><pre><span></span><code><span class="n">teleprompter</span> <span class="o">=</span> <span class="n">BootstrapFewShot</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="n">is_valid</span><span class="p">)</span>
<span class="n">reviewer</span> <span class="o">=</span> <span class="n">teleprompter</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">Reviewer</span><span class="p">(),</span> <span class="n">trainset</span><span class="o">=</span><span class="n">io_pairs</span><span class="p">)</span>
</code></pre></div>

<h3>Reflection: Is this a good reviewer? ðŸ¤”</h3>
<p><img src="https://manishs.org/blog/images/lgtm.jpeg" alt="drawing" width="30%" height="20%" style="float: right;"/>
It is relatively easy to write a valid review for a PR. </p>
<p>But, a good reviewer writes <em>concise</em>, <em>constructive</em>, and <em>informative</em> reviews. The question is, <strong>how do we capture and ensure these properties in a program?</strong></p>
<h3>&ldquo;Sketching&rdquo; the Solution (pun intended)</h3>
<p>In traditional program synthesis, particularly in sketching <a href="https://people.csail.mit.edu/asolar/papers/thesis.pdf">[Solar-Lezama, 2008]</a>, developers provide a high-level outline of a programâ€” a <strong>sketch</strong>â€”along with a set of <strong>assertions</strong> that specify the desired behavior. The synthesizer then fills in the details, turning the sketch into a fully-fledged program that adheres to the assertions.</p>
<blockquote>
<p>Assertions in a sketch enable you to express intuitive insights 
without overthinking the implementation details.</p>
</blockquote>
<p>ðŸ’¡ Wait? By now, we know that DSPy is a sophisticated program synthesizer at its core. 
<label for="sn-demo" class="margin-toggle sidenote-number"></label>
<input type="checkbox" id="sn-demo" class="margin-toggle"/>
<span class="sidenote">
    It takes a program specification (<code>Reviewer</code>) and a set of I/O pairs (<code>io_pairs</code>) and returns a tuned program (prompt) that satisfies the spec.
</span></p>
<p><strong>Why not guide DSPy with assertions?</strong></p>
<h3>Introducing DSPy Assertions</h3>
<p>We introduce to DSPy: <strong>LM Assertions</strong>.
As simple as one-liners, they are assertion style constraints on LM outputs.
We distinguish two types of constraints: <code>Assert</code> (hard) and <code>Suggest</code> (soft):</p>
<div class="highlight"><pre><span></span><code><span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">constraint</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>
<span class="n">dspy</span><span class="o">.</span><span class="n">Suggest</span><span class="p">(</span><span class="n">constraint</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>
</code></pre></div>

<p>Unlike regular assertions, LM assertions are more than just monitors.
On violating the constraint, the execution pauses, and the LM program
attempts to recover from the violation by backtracking to the failing module.
During recovery, the construct uses reflective information to self-correct and continue execution. <code>Asserts</code> fail the program if irrecoverable, while <code>Suggests</code> continue execution.
<label for="sn-demo" class="margin-toggle sidenote-number"></label>
<input type="checkbox" id="sn-demo" class="margin-toggle"/> 
<span class="sidenote">
    More about how this works in our <a href="https://github.com/stanfordnlp/dspy/blob/main/DSPy_Assert.pdf">paper</a>.
    This <a href="https://twitter.com/lateinteraction/status/1735326551393161563">tweet</a> is also a great start.
</span></p>
<p>Here&rsquo;s how we can use a few LM assertions to build our &ldquo;good&rdquo; reviewer:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Reviewer</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gen_review</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="s2">&quot;pull_request -&gt; review, status&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_review</span><span class="p">(</span><span class="n">pull_request</span><span class="o">=</span><span class="n">pr</span><span class="p">)</span>

    <span class="c1"># Assert that the review is concise.</span>
    <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">review</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">,</span> 
        <span class="s2">&quot;review must be concise&quot;</span><span class="p">)</span>

    <span class="c1"># Suggest that the review be constructive.</span>
    <span class="n">dspy</span><span class="o">.</span><span class="n">Suggest</span><span class="p">(</span><span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">review</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;lgtm&quot;</span><span class="p">),</span> 
        <span class="s2">&quot;review must be constructive&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<p>That&rsquo;s it! We can now use DSPy to compile a reviewer that satisfies these assertions and suggestions. Our paper evaluates these new constructs and finds that resulting programs are more robust and performant!</p>
<h3>Conclusion</h3>
<p>LM assertions are simple powerful constructs for guiding LMs toward desired outputs.
There are natural connections between traditional program synthesis and self-refining LM programs with assertions.
We are excited to explore these connections further and build a next-generation programming paradigm.</p>
<p>Read more in our <a href="https://github.com/stanfordnlp/dspy/blob/main/DSPy_Assert.pdf">paper</a> and checkout our <a href="https://github.com/stanfordnlp/dspy/blob/main/dspy/primitives/assertions.py">Github</a>.</p>
</section>


                <footer class="de-emphasize">
                    <p>Finalized at 6:31 AM.
                    <p>Tagged with
                    <a href="https://manishs.org/blog/tags/dspy/" class="tags">DSPy</a>,                     <a href="https://manishs.org/blog/tags/llm/" class="tags">LLM</a>,                     <a href="https://manishs.org/blog/tags/assertions/" class="tags">Assertions</a>,                     <a href="https://manishs.org/blog/tags/program-recovery/" class="tags">Program Recovery</a>,                     <a href="https://manishs.org/blog/tags/program-synthesis/" class="tags">Program Synthesis</a>, and                     <a href="https://manishs.org/blog/tags/pl/" class="tags">PL</a>.                </footer>
            </article>
        <footer>
<p class="de-emphasize copyright">&copy;2019&ndash;2023 Your Name. All rights reserved.        </footer>
    </main>
</body>
</html>